<%
const currentRole = role || 'guest';
const isAdmin = currentRole === "admin";
const isNurse = currentRole === "nurse";
const isAgent = currentRole === "agent";
const canEdit = isAdmin || isNurse;

const nurseId = nurse && nurse.id ? nurse.id : "";
const userId = nurse && (nurse.userId || nurse.user_id) ? (nurse.userId || nurse.user_id) : "";
const fullName = String((nurse && (nurse.fullName || nurse.full_name)) || "Nurse");
const status = String((nurse && (nurse.status || nurse.profileStatus || nurse.profile_status)) || "Pending");
const statusKey = status.toLowerCase();
const city = String((nurse && nurse.city) || "");
const workCity = String((nurse && (nurse.workCity || nurse.work_city)) || "");
const currentAddress = String((nurse && (nurse.currentAddress || nurse.current_address || nurse.address)) || "");
const gender = String((nurse && nurse.gender) || "Not Specified");
const email = String((nurse && nurse.email) || "");
const phone = String((nurse && (nurse.phoneNumber || nurse.phone_number)) || "");
const educationLevel = String((nurse && (nurse.educationLevel || nurse.education_level)) || "");
const experienceYears = Number.parseInt((nurse && (nurse.experienceYears || nurse.experience_years)) || 0, 10) || 0;
const referralCode = String((nurse && (nurse.referralCode || nurse.referral_code)) || "");
const profileStatus = String((nurse && (nurse.profileStatus || nurse.profile_status)) || "");
const isAvailable = nurse && nurse.isAvailable === false ? false : true;
const emailVerified = Boolean(nurse && (nurse.emailVerified || nurse.email_verified));
const profileImage = (nurse && (nurse.profileImageUrl || nurse.profile_image_url || nurse.profileImagePath || nurse.profile_image_path)) || "";
const availability = Array.isArray(nurse && nurse.availability) ? nurse.availability : [];
const skills = Array.isArray(nurse && nurse.skills) ? nurse.skills : [];
const qualifications = Array.isArray(nurse && nurse.qualifications) ? nurse.qualifications : [];
const qualificationDetails = qualifications
  .map((item) => {
    if (item && typeof item === "object") {
      return {
        name: String(item.name || "").trim(),
        certificateUrl: item.certificate_url || null,
        verified: Boolean(item.verified)
      };
    }
    return {
      name: String(item || "").trim(),
      certificateUrl: null,
      verified: false
    };
  })
  .filter((item) => item.name);
const qualificationNames = qualifications
  .map((item) => (item && typeof item === "object" ? item.name : item))
  .map((item) => String(item || "").trim())
  .filter(Boolean);

const skillOptions = [...new Set([
  ...((typeof MASTER_SKILL_OPTIONS !== "undefined" && Array.isArray(MASTER_SKILL_OPTIONS)) ? MASTER_SKILL_OPTIONS : []),
  ...skills
])].filter(Boolean);
const availabilityOptions = [...new Set([
  "Weekday Morning",
  "Weekday Evening",
  "Night Shift",
  "Weekend",
  "On Call",
  ...availability
])].filter(Boolean);
const qualificationOptions = [...new Set([
  ...((typeof MASTER_QUALIFICATION_OPTIONS !== "undefined" && Array.isArray(MASTER_QUALIFICATION_OPTIONS)) ? MASTER_QUALIFICATION_OPTIONS : []),
  ...qualificationNames
])].filter(Boolean);

const availabilityText = availability.length
  ? availability.join(", ")
  : (isAvailable ? "Available" : "Unavailable");
const qualificationsText = qualifications
  .map((item) => (item && typeof item === "object" ? item.name : item))
  .map((item) => String(item || "").trim())
  .filter(Boolean)
  .join(", ");

const aadhaarRaw = String(
  (nurse && (nurse.aadhaarNumber || nurse.aadharNumber || nurse.aadhaar_number || nurse.aadhar_number)) || ""
).replace(/\D/g, "");
function maskAadhar(value) {
  if (!value || value.length < 4) return "XXXX-XXXX-XXXX";
  return "XXXX-XXXX-" + value.slice(-4);
}
const aadhaarDisplay = isAdmin ? (aadhaarRaw || "Not provided") : maskAadhar(aadhaarRaw);

const editAction = isAdmin ? `/admin/nurses/${nurseId}/update` : "/nurse/profile/basic-edit";
const backLink = isAdmin ? "/admin/nurses" : (isAgent ? "/agent" : "");
const backLabel = isAdmin ? "Back to Nurses" : (isAgent ? "Back to Dashboard" : "");
%>

<section class="nurse-profile-shell" id="nurseProfileShell">
  <% if (backLink) { %>
    <a class="np-back-link" href="<%= backLink %>"><%= backLabel %></a>
  <% } %>

  <article class="np-card np-header-card">
    <div class="np-header-left">
      <% if (isNurse) { %>
        <div class="np-avatar-menu-shell" id="npAvatarMenuShell">
          <button
            type="button"
            class="np-avatar-button"
            id="npAvatarMenuTrigger"
            aria-haspopup="menu"
            aria-expanded="false"
          >
            <span class="np-avatar-wrap">
              <% if (profileImage) { %>
                <img src="<%= profileImage %>" alt="<%= fullName %>" class="np-avatar">
              <% } else { %>
                <span class="np-avatar-fallback"><%= fullName.charAt(0).toUpperCase() %></span>
              <% } %>
            </span>
          </button>

          <div class="np-avatar-menu" id="npAvatarMenu" role="menu" aria-hidden="true">
            <% if (nurse.profileImageUrl || nurse.profileImagePath) { %>
              <a
                href="<%= profileImage %>"
                target="_blank"
                rel="noopener noreferrer"
                class="np-avatar-menu-action"
                role="menuitem"
              >
                View Profile Picture
              </a>
              <button type="button" class="np-avatar-menu-action" data-avatar-upload="true" role="menuitem">
                Change Profile Picture
              </button>
              <form
                action="/nurse/profile/delete-photo"
                method="POST"
                class="np-avatar-menu-inline-form"
                onsubmit="return confirm('Delete profile picture?');"
              >
                <button type="submit" class="np-avatar-menu-action danger" role="menuitem">
                  Delete Profile Picture
                </button>
              </form>
            <% } else { %>
              <button type="button" class="np-avatar-menu-action" data-avatar-upload="true" role="menuitem">
                Upload Profile Picture
              </button>
            <% } %>
          </div>

          <form
            action="/nurse/profile/upload-photo"
            method="POST"
            enctype="multipart/form-data"
            id="npProfilePhotoForm"
            class="np-hidden-upload-form"
          >
            <input
              type="file"
              id="npProfilePhotoInput"
              name="profileImage"
              required
              accept=".jpg,.jpeg,.png"
            >
            <button type="submit">Upload</button>
          </form>
        </div>
      <% } else { %>
        <div class="np-avatar-wrap">
          <% if (profileImage) { %>
            <img src="<%= profileImage %>" alt="<%= fullName %>" class="np-avatar">
          <% } else { %>
            <span class="np-avatar-fallback"><%= fullName.charAt(0).toUpperCase() %></span>
          <% } %>
        </div>
      <% } %>

      <div class="np-header-copy">
        <h1><%= fullName %></h1>
        <div class="np-badges">
          <span class="np-badge status <%= statusKey %>"><%= status %></span>
          <span class="np-badge availability <%= isAvailable ? "available" : "unavailable" %>">
            <%= isAvailable ? "Available" : "Unavailable" %>
          </span>
        </div>
        <p class="np-meta">
          Experience: <strong><%= experienceYears %> years</strong>
          <% if (referralCode) { %>
            <span class="np-dot"></span>
            Referral: <code><%= referralCode %></code>
          <% } %>
        </p>
      </div>
    </div>

    <% if (canEdit) { %>
      <div class="np-header-actions">
        <button type="button" class="btn primary" id="npToggleEditBtn">Edit Profile</button>
      </div>
    <% } %>
  </article>

  <% if (canEdit) { %>
  <form
    id="profileForm"
    method="POST"
    action="<%= editAction %>"
    class="np-profile-form"
    <%- isNurse ? 'enctype="multipart/form-data"' : "" %>
  >
    <% if (isAdmin) { %>
      <input type="hidden" name="statusFilter" value="">
    <% } %>
  <% } %>

    <article class="np-card np-tabs-card">
      <div class="np-tabs">
        <button type="button" class="np-tab-btn active" data-np-tab="np-basic-tab">Basic Info</button>
        <button type="button" class="np-tab-btn" data-np-tab="np-prof-tab">Professional</button>
        <button type="button" class="np-tab-btn" data-np-tab="np-security-tab">Security</button>
      </div>
    </article>

    <section class="np-tab-panel active" id="np-basic-tab">
      <article class="np-card">
        <h2>Basic Information</h2>
        <div class="np-grid">
          <div class="np-field">
            <label>Full Name</label>
            <div class="np-view"><%= fullName || "-" %></div>
            <% if (canEdit) { %>
              <input class="np-edit-field" type="text" name="fullName" value="<%= fullName %>">
            <% } %>
          </div>

          <div class="np-field">
            <label>Email</label>
            <div class="np-view"><%= email || "-" %></div>
            <% if (isAdmin) { %>
              <input class="np-edit-field" type="email" name="email" value="<%= email %>" required>
            <% } %>
          </div>

          <div class="np-field">
            <label>Mobile</label>
            <div class="np-view"><%= phone || "-" %></div>
            <% if (canEdit) { %>
              <input class="np-edit-field" type="text" name="phoneNumber" value="<%= phone %>" placeholder="10-digit mobile number">
            <% } %>
          </div>

          <div class="np-field">
            <label>Gender</label>
            <div class="np-view"><%= gender || "-" %></div>
            <% if (canEdit) { %>
              <select class="np-edit-field" name="gender">
                <option value="Not Specified" <%= gender === "Not Specified" ? "selected" : "" %>>Not Specified</option>
                <option value="Female" <%= gender === "Female" ? "selected" : "" %>>Female</option>
                <option value="Male" <%= gender === "Male" ? "selected" : "" %>>Male</option>
                <option value="Other" <%= gender === "Other" ? "selected" : "" %>>Other</option>
              </select>
            <% } %>
          </div>

          <div class="np-field">
            <label>City</label>
            <div class="np-view"><%= city || "-" %></div>
            <% if (canEdit) { %>
              <input class="np-edit-field" type="text" name="city" value="<%= city %>">
            <% } %>
          </div>

          <div class="np-field">
            <label>Work City</label>
            <div class="np-view"><%= workCity || "-" %></div>
            <% if (canEdit) { %>
              <input class="np-edit-field" type="text" name="workCity" value="<%= workCity %>">
            <% } %>
          </div>

          <div class="np-field np-span-2">
            <label>Current Address</label>
            <div class="np-view"><%= currentAddress || "-" %></div>
            <% if (canEdit) { %>
              <textarea class="np-edit-field" name="currentAddress" rows="3"><%= currentAddress %></textarea>
            <% } %>
          </div>

          <div class="np-field">
            <label>Aadhaar</label>
            <div class="np-view"><%= aadhaarDisplay %></div>
            <% if (isAdmin) { %>
              <input class="np-edit-field" type="text" name="aadharNumber" value="<%= aadhaarRaw %>" maxlength="12" placeholder="12-digit Aadhaar">
            <% } %>
          </div>
        </div>
      </article>
    </section>

    <section class="np-tab-panel" id="np-prof-tab">
      <article class="np-card">
        <h2>Professional Details</h2>
        <div class="np-grid">
          <div class="np-field">
            <label>Experience (Years)</label>
            <div class="np-view"><%= experienceYears %></div>
            <% if (canEdit) { %>
              <input class="np-edit-field" type="number" min="0" max="60" name="experienceYears" value="<%= experienceYears %>">
            <% } %>
          </div>

          <div class="np-field">
            <label>Education Level</label>
            <div class="np-view"><%= educationLevel || "-" %></div>
            <% if (canEdit) { %>
              <select class="np-edit-field" name="educationLevel">
                <option value="">Select</option>
                <option value="10th Pass" <%= educationLevel === "10th Pass" ? "selected" : "" %>>10th Pass</option>
                <option value="12th Pass" <%= educationLevel === "12th Pass" ? "selected" : "" %>>12th Pass</option>
                <option value="ANM" <%= educationLevel === "ANM" ? "selected" : "" %>>ANM</option>
                <option value="GNM" <%= educationLevel === "GNM" ? "selected" : "" %>>GNM</option>
                <option value="BSc Nursing" <%= educationLevel === "BSc Nursing" ? "selected" : "" %>>BSc Nursing</option>
                <option value="MSc Nursing" <%= educationLevel === "MSc Nursing" ? "selected" : "" %>>MSc Nursing</option>
                <option value="GDA" <%= educationLevel === "GDA" ? "selected" : "" %>>GDA</option>
                <option value="Other" <%= educationLevel === "Other" ? "selected" : "" %>>Other</option>
              </select>
            <% } %>
          </div>

          <div class="np-field np-span-2">
            <label>Skills</label>
            <div id="skillsViewSection" class="np-view np-chip-wrap view-mode">
              <% if (skills.length) { %>
                <% skills.forEach((item) => { %>
                  <span class="np-chip"><%= item %></span>
                <% }) %>
              <% } else { %>
                <span>-</span>
              <% } %>
            </div>
            <% if (canEdit) { %>
              <div id="skillsEditSection" class="edit-mode" style="display: none;">
                <input class="np-edit-field" type="hidden" name="skills" value="">
                <div class="np-edit-field np-skill-tags" id="selectedSkillsContainer"></div>
                <input
                  class="np-edit-field np-skill-search"
                  type="text"
                  id="skillSearch"
                  placeholder="Search skills"
                >
                <div class="np-edit-field np-skill-dropdown" id="skillsDropdown"></div>
                <select
                  class="np-edit-field np-multi-select np-skill-select-hidden"
                  id="skillsSelect"
                  name="skills"
                  multiple
                  size="8"
                >
                  <% skillOptions.forEach((item) => { %>
                    <option value="<%= item %>" <%= skills.includes(item) ? "selected" : "" %>><%= item %></option>
                  <% }) %>
                </select>
              </div>
            <% } %>
          </div>

          <div class="np-field np-span-2">
            <label>Qualifications</label>
            <div class="np-view np-chip-wrap">
              <% if (qualificationsText) { %>
                <% qualificationsText.split(",").forEach((item) => { %>
                  <span class="np-chip"><%= item.trim() %></span>
                <% }) %>
              <% } else { %>
                <span>-</span>
              <% } %>
            </div>
            <% if (isAdmin) { %>
              <input class="np-edit-field" type="hidden" name="qualifications" value="">
              <select class="np-edit-field np-multi-select" name="qualifications" multiple size="6">
                <% qualificationOptions.forEach((item) => { %>
                  <option value="<%= item %>" <%= qualificationNames.includes(item) ? "selected" : "" %>><%= item %></option>
                <% }) %>
              </select>
            <% } %>
          </div>

          <div class="np-field np-span-2">
            <label>Availability</label>
            <div class="np-view"><%= availabilityText || "-" %></div>
            <% if (canEdit) { %>
              <input class="np-edit-field" type="hidden" name="availability" value="">
              <select class="np-edit-field np-multi-select" name="availability" multiple size="5">
                <% availabilityOptions.forEach((item) => { %>
                  <option value="<%= item %>" <%= availability.includes(item) ? "selected" : "" %>><%= item %></option>
                <% }) %>
              </select>
            <% } %>
          </div>

          <div class="np-field">
            <label>Public Availability</label>
            <div class="np-view"><%= isAvailable ? "Available" : "Unavailable" %></div>
            <% if (canEdit) { %>
              <select class="np-edit-field" name="isAvailable">
                <option value="true" <%= isAvailable ? "selected" : "" %>>Available</option>
                <option value="false" <%= !isAvailable ? "selected" : "" %>>Unavailable</option>
              </select>
            <% } %>
          </div>

          <div class="np-field">
            <label>Referral Code</label>
            <div class="np-view"><%= referralCode || "-" %></div>
            <% if (isAdmin) { %>
              <input class="np-edit-field" type="text" name="referralCode" value="<%= referralCode %>">
            <% } %>
          </div>

          <% if (isAdmin) { %>
          <div class="np-field">
            <label>Status</label>
            <div class="np-view"><%= status %></div>
            <select class="np-edit-field" name="status">
              <option value="Pending" <%= status === "Pending" ? "selected" : "" %>>Pending</option>
              <option value="Approved" <%= status === "Approved" ? "selected" : "" %>>Approved</option>
              <option value="Rejected" <%= status === "Rejected" ? "selected" : "" %>>Rejected</option>
            </select>
          </div>

          <div class="np-field">
            <label>Profile Status</label>
            <div class="np-view"><%= profileStatus || "-" %></div>
            <input class="np-edit-field" type="text" name="profileStatus" value="<%= profileStatus %>">
          </div>
          <% } %>
        </div>

        <% if (isAdmin && status === "Pending") { %>
        <div class="np-inline-actions">
          <button type="submit" name="statusAction" value="Approved" class="btn primary">Approve Nurse</button>
          <button type="submit" name="statusAction" value="Rejected" class="btn danger">Reject Nurse</button>
        </div>
        <% } %>

      </article>
    </section>

    <section class="np-tab-panel" id="np-security-tab">
      <article class="np-card">
        <h2>Security</h2>
        <div class="np-grid">
          <div class="np-field">
            <label>Email Verification</label>
            <div class="np-view">
              <span class="np-badge <%= emailVerified ? "verified" : "unverified" %>">
                <%= emailVerified ? "Verified" : "Not Verified" %>
              </span>
            </div>
            <% if (isAdmin) { %>
              <select class="np-edit-field" name="emailVerified">
                <option value="true" <%= emailVerified ? "selected" : "" %>>Verified</option>
                <option value="false" <%= !emailVerified ? "selected" : "" %>>Not Verified</option>
              </select>
            <% } %>
          </div>
        </div>

        <% if (canEdit) { %>
          <input type="hidden" name="redirectTo" value="<%= isAdmin ? `/admin/user/view/nurse/${nurseId}` : '/nurse/profile' %>">
        <% } %>

        <% if (isAdmin && userId) { %>
          <div class="np-security-actions">
            <button type="submit" class="btn warning" formaction="/admin/user/<%= userId %>/reset-password" formmethod="POST">
              Reset Password
            </button>

            <div class="np-pass-form">
              <input type="password" name="newPassword" placeholder="New password">
              <button type="submit" class="btn primary" formaction="/admin/user/<%= userId %>/change-password" formmethod="POST">
                Change Password
              </button>
            </div>

            <button
              type="submit"
              class="btn danger"
              formaction="/admin/user/<%= userId %>/delete"
              formmethod="POST"
              onclick="return confirm('Delete this user account permanently?');"
            >
              Delete Account
            </button>
          </div>
        <% } %>

        <% if (isNurse) { %>
          <div class="np-security-actions">
            <div class="np-pass-form">
              <input type="password" name="currentPassword" placeholder="Current password">
              <input type="password" name="newPassword" placeholder="New password">
              <input type="password" name="confirmPassword" placeholder="Confirm new password">
              <button type="submit" class="btn primary" formaction="/nurse/password/change" formmethod="POST">
                Change Password
              </button>
            </div>
          </div>
        <% } %>

        <% if (isAgent) { %>
          <p class="np-muted">Security controls are not available for agent role.</p>
        <% } %>
      </article>
    </section>

    <% if (canEdit) { %>
      <div class="np-edit-actions" id="npEditActions">
        <button type="button" class="btn" id="npCancelEditBtn">Cancel</button>
        <button type="submit" class="btn primary" form="profileForm">Save</button>
      </div>
    </form>
    <% } %>

  <% if (isNurse) { %>
    <article class="np-card">
      <h2>Qualifications & Certificates</h2>
      <div class="np-qual-read">
        <% if (qualificationDetails.length) { %>
          <div class="np-view np-chip-wrap">
            <% qualificationDetails.forEach((item, index) => { %>
              <span class="np-chip"><%= item.name %></span>
              <% if (index < qualificationDetails.length - 1) { %>
                <span class="np-muted">|</span>
              <% } %>
            <% }) %>
          </div>
          <div class="np-qual-read-list">
            <% qualificationDetails.forEach((item) => { %>
              <div class="np-qual-read-item">
                <span class="np-qual-read-name"><%= item.name %></span>
                <% if (item.certificateUrl) { %>
                  <a href="<%= item.certificateUrl %>" target="_blank" rel="noopener noreferrer">
                    View Document
                  </a>
                <% } else { %>
                  <form method="POST" action="/nurse/profile/upload-qualification-document" enctype="multipart/form-data" class="np-qual-upload-form">
                    <input type="hidden" name="qualificationName" value="<%= item.name %>">
                    <input type="file" name="qualificationDocument" accept=".pdf,.jpg,.jpeg,.png" required>
                    <button type="submit" class="btn small">Upload Document</button>
                    <span class="np-qual-pending-badge">Document Pending</span>
                  </form>
                <% } %>
              </div>
            <% }) %>
          </div>
        <% } else { %>
          <p class="np-muted">No qualifications added yet.</p>
        <% } %>
      </div>
      <div class="np-qual-edit">
        <p class="np-muted">Select qualifications and upload certificate for each selected qualification.</p>
        <%- include("../partials/nurse-qualification-module", { nurse, profileFormId: "profileForm" }) %>
      </div>
    </article>
  <% } %>
</section>

<style>
.nurse-profile-shell {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.np-back-link {
  width: fit-content;
  color: #0f5d9b;
  font-weight: 700;
  text-decoration: none;
}

.np-card {
  background: #ffffff;
  border: 1px solid #d8e7f3;
  border-radius: 22px;
  box-shadow: 0 10px 28px rgba(15, 42, 71, 0.08);
  padding: 1.2rem;
}

.np-header-card {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 1rem;
}

.np-header-left {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.np-avatar-menu-shell {
  position: relative;
  display: inline-flex;
}

.np-avatar-button {
  border: none;
  background: transparent;
  padding: 0;
  border-radius: 50%;
  cursor: pointer;
}

.np-avatar-button:focus-visible {
  outline: 2px solid #0f7fcf;
  outline-offset: 3px;
}

.np-avatar-wrap {
  width: 112px;
  height: 112px;
  border-radius: 50%;
  overflow: hidden;
  flex-shrink: 0;
  border: 4px solid #e4f1fb;
  background: #f0f7fd;
  display: grid;
  place-items: center;
}

.np-avatar {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.np-avatar-menu {
  display: none;
  position: absolute;
  top: calc(100% + 10px);
  left: 0;
  min-width: 220px;
  background: #ffffff;
  border: 1px solid #d8e7f3;
  border-radius: 12px;
  box-shadow: 0 12px 28px rgba(15, 42, 71, 0.14);
  padding: 0.35rem;
  z-index: 20;
}

.np-avatar-menu-shell:hover .np-avatar-menu,
.np-avatar-menu-shell.is-open .np-avatar-menu {
  display: block;
}

.np-avatar-menu-action {
  display: block;
  width: 100%;
  border: none;
  background: transparent;
  text-align: left;
  border-radius: 8px;
  padding: 0.52rem 0.6rem;
  font: inherit;
  color: #163d62;
  text-decoration: none;
  cursor: pointer;
}

.np-avatar-menu-action:hover {
  background: #edf5fc;
}

.np-avatar-menu-action.danger {
  color: #9e1f1f;
}

.np-avatar-menu-inline-form {
  margin: 0;
}

.np-hidden-upload-form {
  display: none;
}

.np-avatar-fallback {
  font-size: 2rem;
  font-weight: 800;
  color: #10416a;
}

.np-header-copy h1 {
  margin: 0 0 0.45rem;
  font-size: clamp(1.4rem, 3vw, 1.9rem);
}

.np-badges {
  display: flex;
  flex-wrap: wrap;
  gap: 0.45rem;
}

.np-badge {
  display: inline-flex;
  align-items: center;
  border-radius: 999px;
  padding: 0.32rem 0.72rem;
  font-size: 0.78rem;
  font-weight: 700;
}

.np-badge.status.pending {
  background: #fff1d8;
  color: #9a5a00;
}

.np-badge.status.approved {
  background: #dcf8e7;
  color: #16663c;
}

.np-badge.status.rejected {
  background: #fde2e2;
  color: #9e1f1f;
}

.np-badge.availability.available {
  background: #e5f2ff;
  color: #0d4c82;
}

.np-badge.availability.unavailable {
  background: #fce7f3;
  color: #9d174d;
}

.np-badge.verified {
  background: #dcfce7;
  color: #166534;
}

.np-badge.unverified {
  background: #fee2e2;
  color: #991b1b;
}

.np-meta {
  margin-top: 0.55rem;
  color: #4e6880;
  font-size: 0.95rem;
}

.np-dot {
  display: inline-block;
  width: 4px;
  height: 4px;
  border-radius: 50%;
  background: #8aa0b5;
  margin: 0 8px 2px;
}

.np-tabs-card {
  padding: 0.6rem;
}

.np-tabs {
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 0.5rem;
}

.np-tab-btn {
  border: 1px solid #d6e3ef;
  background: #f5f9fd;
  color: #24445f;
  border-radius: 14px;
  padding: 0.62rem 0.8rem;
  font-weight: 700;
  cursor: pointer;
}

.np-tab-btn.active {
  background: #0f7fcf;
  color: #ffffff;
  border-color: #0f7fcf;
}

.np-tab-panel {
  display: none;
}

.np-tab-panel.active {
  display: block;
}

.np-card h2 {
  margin: 0 0 1rem;
  font-size: 1.15rem;
}

.np-grid {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 0.9rem;
}

.np-field {
  display: flex;
  flex-direction: column;
  gap: 0.35rem;
}

.np-field label {
  font-size: 0.74rem;
  letter-spacing: 0.05em;
  text-transform: uppercase;
  font-weight: 700;
  color: #56718b;
}

.np-span-2 {
  grid-column: 1 / -1;
}

.np-view {
  min-height: 42px;
  border: 1px solid #dbe9f4;
  border-radius: 12px;
  background: #f8fbfe;
  padding: 0.62rem 0.72rem;
  color: #11304f;
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 0.4rem;
}

.np-edit-field {
  display: none;
  width: 100%;
  min-height: 42px;
  border: 1px solid #c6dae8;
  border-radius: 12px;
  background: #ffffff;
  padding: 0.62rem 0.72rem;
  color: #11304f;
  font: inherit;
}

.nurse-profile-shell.is-editing .np-view {
  display: none;
}

.nurse-profile-shell.is-editing .np-edit-field {
  display: block;
}

.np-check {
  display: none;
  align-items: center;
  gap: 0.55rem;
  font-weight: 600;
}

.np-check input {
  width: auto;
}

.nurse-profile-shell.is-editing .np-check {
  display: inline-flex;
}

.np-chip-wrap {
  min-height: 42px;
}

.np-chip {
  display: inline-flex;
  align-items: center;
  border: 1px solid #c9dff0;
  border-radius: 999px;
  background: #edf5fc;
  color: #164a77;
  font-size: 0.8rem;
  padding: 0.24rem 0.58rem;
}

.np-inline-actions {
  margin-top: 1rem;
  display: flex;
  gap: 0.65rem;
  flex-wrap: wrap;
}

.np-security-actions {
  margin-top: 1rem;
  display: flex;
  flex-direction: column;
  gap: 0.65rem;
}

.np-pass-form {
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr)) auto;
  gap: 0.55rem;
}

.np-pass-form input {
  min-height: 42px;
  border: 1px solid #c6dae8;
  border-radius: 10px;
  padding: 0.55rem 0.65rem;
}

.np-multi-select {
  min-height: 140px;
}

.np-skill-search {
  margin-bottom: 0.45rem;
}

#skillsViewSection {
  display: flex;
}

#skillsEditSection {
  display: none;
}

.nurse-profile-shell.is-editing #skillsViewSection {
  display: none;
}

.nurse-profile-shell.is-editing #skillsEditSection {
  display: block !important;
}

.np-skill-tags {
  min-height: 42px;
  display: flex;
  flex-wrap: wrap;
  gap: 0.45rem;
  align-items: center;
  margin-bottom: 0.45rem;
}

.np-skill-tags-empty {
  color: #5b7388;
  font-size: 0.9rem;
}

.skill-tag {
  display: inline-flex;
  align-items: center;
  gap: 0.35rem;
  border: 1px solid #c9dff0;
  border-radius: 999px;
  background: #edf5fc;
  color: #164a77;
  font-size: 0.82rem;
  padding: 0.24rem 0.34rem 0.24rem 0.6rem;
}

.remove-skill {
  width: 24px;
  height: 24px;
  border: none;
  border-radius: 999px;
  background: #d9ecfa;
  color: #0f4f83;
  font-size: 1rem;
  line-height: 1;
  cursor: pointer;
}

.remove-skill:hover {
  background: #c4e2f8;
}

.np-skill-dropdown {
  min-height: 44px;
  max-height: 200px;
  overflow-y: auto;
  border: 1px solid #c6dae8;
  border-radius: 12px;
  background: #ffffff;
  padding: 0.25rem;
}

.np-skill-option {
  width: 100%;
  border: none;
  background: transparent;
  border-radius: 9px;
  text-align: left;
  padding: 0.52rem 0.58rem;
  color: #11304f;
  cursor: pointer;
}

.np-skill-option:hover {
  background: #edf5fc;
}

.np-skill-option.is-selected {
  color: #5b7388;
  cursor: default;
}

.np-skill-option.add-new {
  color: #0f5d9b;
  font-weight: 700;
}

.np-skill-select-hidden {
  display: none !important;
}

.qualification-module {
  margin-top: 0.9rem;
}

.qualification-item {
  border: 1px solid #d9e7f3;
  border-radius: 12px;
  padding: 0.8rem;
  margin-top: 0.6rem;
  background: #f8fbfe;
}

.qualification-item label {
  text-transform: none;
  letter-spacing: normal;
  color: #11304f;
}

.qualification-item input[type="file"] {
  margin-top: 0.45rem;
  width: 100%;
}

.np-muted {
  color: #5b7388;
  margin: 0.25rem 0 0;
}

.np-qual-read {
  display: block;
}

.np-qual-edit {
  display: none;
}

.np-qual-read-list {
  margin-top: 0.8rem;
  display: grid;
  gap: 0.55rem;
}

.np-qual-read-item {
  border: 1px solid #d9e7f3;
  border-radius: 12px;
  background: #f8fbfe;
  padding: 0.75rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.7rem;
  flex-wrap: wrap;
}

.np-qual-read-name {
  font-weight: 700;
  color: #11304f;
}

.np-qual-read-item a {
  color: #0f5d9b;
  text-decoration: none;
  font-weight: 600;
}

.np-qual-read-item a:hover {
  text-decoration: underline;
}

.np-qual-upload-form {
  display: flex;
  align-items: center;
  gap: 0.45rem;
  flex-wrap: wrap;
}

.np-qual-pending-badge {
  display: inline-flex;
  align-items: center;
  border-radius: 999px;
  padding: 0.2rem 0.5rem;
  font-size: 0.74rem;
  font-weight: 700;
  background: #fff1d8;
  color: #9a5a00;
}

.np-edit-actions {
  display: none;
  justify-content: flex-end;
  gap: 0.6rem;
  padding: 0.4rem 0;
}

.nurse-profile-shell.is-editing .np-edit-actions {
  display: flex;
}

.nurse-profile-shell.is-editing .np-qual-read {
  display: none;
}

.nurse-profile-shell.is-editing .np-qual-edit {
  display: block;
}

.btn.warning {
  border-color: #f0c14b;
  background: #ffe8b3;
  color: #7a4d00;
}

.btn.danger {
  border-color: #ef9a9a;
  background: #ffe4e6;
  color: #9f1239;
}

@media (max-width: 900px) {
  .np-header-card {
    flex-direction: column;
    align-items: flex-start;
  }

  .np-grid {
    grid-template-columns: 1fr;
  }

  .np-span-2 {
    grid-column: auto;
  }

  .np-pass-form {
    grid-template-columns: 1fr;
  }
}
</style>

<script>
(() => {
  const shell = document.getElementById("nurseProfileShell");
  if (!shell) return;

  const tabButtons = shell.querySelectorAll(".np-tab-btn");
  const tabPanels = shell.querySelectorAll(".np-tab-panel");

  tabButtons.forEach((button) => {
    button.addEventListener("click", () => {
      const target = button.getAttribute("data-np-tab");
      tabButtons.forEach((item) => item.classList.remove("active"));
      tabPanels.forEach((panel) => panel.classList.remove("active"));
      button.classList.add("active");
      const panel = shell.querySelector(`#${target}`);
      if (panel) panel.classList.add("active");
    });
  });

  const editButton = document.getElementById("npToggleEditBtn");
  const cancelButton = document.getElementById("npCancelEditBtn");
  const profileForm = document.getElementById("profileForm");
  const selectedSkillsContainer = document.getElementById("selectedSkillsContainer");
  const skillSearchInput = document.getElementById("skillSearch");
  const skillSelect = document.getElementById("skillsSelect");
  const skillsDropdown = document.getElementById("skillsDropdown");

  const avatarMenuShell = document.getElementById("npAvatarMenuShell");
  const avatarMenuTrigger = document.getElementById("npAvatarMenuTrigger");
  const avatarMenu = document.getElementById("npAvatarMenu");
  const avatarPhotoInput = document.getElementById("npProfilePhotoInput");
  const avatarPhotoForm = document.getElementById("npProfilePhotoForm");

  let selectedSkills = new Set();
  const normalizeSkillValue = (value) => String(value || "").trim().toLowerCase();
  const getSelectedSkill = (value) => {
    const target = normalizeSkillValue(value);
    if (!target) return null;
    for (const skill of selectedSkills) {
      if (normalizeSkillValue(skill) === target) {
        return skill;
      }
    }
    return null;
  };
  const hasSelectedSkill = (value) => Boolean(getSelectedSkill(value));
  const addSelectedSkill = (value) => {
    const cleanValue = String(value || "").trim();
    if (!cleanValue || hasSelectedSkill(cleanValue)) return false;
    selectedSkills.add(cleanValue);
    return true;
  };
  const removeSelectedSkill = (value) => {
    const existingSkill = getSelectedSkill(value);
    if (!existingSkill) return false;
    selectedSkills.delete(existingSkill);
    return true;
  };
  const ensureSkillOptionExists = (value) => {
    if (!skillSelect) return null;
    const cleanValue = String(value || "").trim();
    if (!cleanValue) return null;

    const existingOption = Array.from(skillSelect.options).find(
      (option) => normalizeSkillValue(option.value) === normalizeSkillValue(cleanValue)
    );
    if (existingOption) return existingOption;

    const newOption = new Option(cleanValue, cleanValue, false, false);
    skillSelect.appendChild(newOption);
    return newOption;
  };
  const updateHiddenSelect = () => {
    if (!skillSelect) return;
    Array.from(skillSelect.options).forEach((option) => {
      option.selected = hasSelectedSkill(option.value);
    });
  };
  const renderSelectedSkills = () => {
    if (!selectedSkillsContainer) return;
    selectedSkillsContainer.innerHTML = "";

    if (!selectedSkills.size) {
      const emptyState = document.createElement("span");
      emptyState.className = "np-skill-tags-empty";
      emptyState.textContent = "No skills selected";
      selectedSkillsContainer.appendChild(emptyState);
      return;
    }

    selectedSkills.forEach((skillName) => {
      const tag = document.createElement("span");
      tag.className = "skill-tag";
      tag.textContent = skillName;

      const removeButton = document.createElement("button");
      removeButton.type = "button";
      removeButton.className = "remove-skill";
      removeButton.textContent = "\u00d7";
      removeButton.setAttribute("aria-label", `Remove ${skillName}`);
      removeButton.addEventListener("click", () => {
        if (!removeSelectedSkill(skillName)) return;
        updateSkillUI();
      });

      tag.appendChild(removeButton);
      selectedSkillsContainer.appendChild(tag);
    });
  };
  const renderSkillsDropdown = () => {
    if (!skillsDropdown || !skillSelect) return;
    skillsDropdown.innerHTML = "";

    const searchTerm = skillSearchInput ? String(skillSearchInput.value || "").trim() : "";
    const termLower = searchTerm.toLowerCase();
    const seen = new Set();
    const optionValues = Array.from(skillSelect.options)
      .map((option) => String(option.value || "").trim())
      .filter(Boolean)
      .filter((value) => {
        const key = normalizeSkillValue(value);
        if (!key || seen.has(key)) return false;
        seen.add(key);
        return true;
      });

    let matchCount = 0;
    optionValues.forEach((skillName) => {
      const matches = !termLower || skillName.toLowerCase().includes(termLower);
      if (!matches) return;
      matchCount += 1;

      const optionButton = document.createElement("button");
      optionButton.type = "button";
      optionButton.className = "np-skill-option";

      if (hasSelectedSkill(skillName)) {
        optionButton.classList.add("is-selected");
        optionButton.textContent = `${skillName} (Selected)`;
        optionButton.disabled = true;
      } else {
        optionButton.textContent = skillName;
        optionButton.addEventListener("click", () => {
          if (!addSelectedSkill(skillName)) return;
          if (skillSearchInput) skillSearchInput.value = "";
          updateSkillUI();
        });
      }

      skillsDropdown.appendChild(optionButton);
    });

    const hasExactSkill = optionValues.some(
      (skillName) => normalizeSkillValue(skillName) === normalizeSkillValue(searchTerm)
    );
    if (!matchCount && searchTerm && !hasExactSkill) {
      const addButton = document.createElement("button");
      addButton.type = "button";
      addButton.className = "np-skill-option add-new";
      addButton.textContent = `Add "${searchTerm}"`;
      addButton.addEventListener("click", () => {
        ensureSkillOptionExists(searchTerm);
        if (!addSelectedSkill(searchTerm)) return;
        if (skillSearchInput) skillSearchInput.value = "";
        updateSkillUI();
      });
      skillsDropdown.appendChild(addButton);
      return;
    }

    if (!skillsDropdown.childElementCount) {
      const noResult = document.createElement("div");
      noResult.className = "np-skill-tags-empty";
      noResult.textContent = "No skills found";
      skillsDropdown.appendChild(noResult);
    }
  };
  const updateSkillUI = () => {
    updateHiddenSelect();
    renderSelectedSkills();
    renderSkillsDropdown();
  };
  const initializeSelectedSkillsFromSelect = () => {
    if (!skillSelect) return;
    selectedSkills = new Set();
    Array.from(skillSelect.options).forEach((option) => {
      if (option.selected) addSelectedSkill(option.value);
    });
    updateSkillUI();
  };

  const setAvatarMenuState = (isOpen) => {
    if (!avatarMenuShell || !avatarMenuTrigger || !avatarMenu) return;
    avatarMenuShell.classList.toggle("is-open", Boolean(isOpen));
    avatarMenuTrigger.setAttribute("aria-expanded", isOpen ? "true" : "false");
    avatarMenu.setAttribute("aria-hidden", isOpen ? "false" : "true");
  };

  if (editButton) {
    editButton.addEventListener("click", () => {
      shell.classList.toggle("is-editing");
      editButton.textContent = shell.classList.contains("is-editing") ? "Editing" : "Edit Profile";
      if (shell.classList.contains("is-editing")) {
        initializeSelectedSkillsFromSelect();
      } else if (skillSearchInput) {
        skillSearchInput.value = "";
      }
    });
  }
  if (cancelButton) {
    cancelButton.addEventListener("click", () => {
      window.location.reload();
    });
  }

  if (skillSearchInput && skillSelect && skillsDropdown && selectedSkillsContainer) {
    skillSearchInput.addEventListener("input", renderSkillsDropdown);
    initializeSelectedSkillsFromSelect();
  }
  if (profileForm && skillSelect) {
    profileForm.addEventListener("submit", () => {
      updateHiddenSelect();
    });
  }

  if (avatarMenuShell && avatarMenuTrigger) {
    avatarMenuTrigger.addEventListener("click", (event) => {
      event.stopPropagation();
      setAvatarMenuState(!avatarMenuShell.classList.contains("is-open"));
    });

    document.addEventListener("click", (event) => {
      if (!avatarMenuShell.contains(event.target)) {
        setAvatarMenuState(false);
      }
    });

    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape") {
        setAvatarMenuState(false);
      }
    });
  }

  shell.querySelectorAll("[data-avatar-upload]").forEach((button) => {
    button.addEventListener("click", () => {
      if (!avatarPhotoInput) return;
      avatarPhotoInput.value = "";
      avatarPhotoInput.click();
      setAvatarMenuState(false);
    });
  });

  if (avatarPhotoInput && avatarPhotoForm) {
    avatarPhotoInput.addEventListener("change", () => {
      if (avatarPhotoInput.files && avatarPhotoInput.files.length > 0) {
        avatarPhotoForm.submit();
      }
    });
  }
})();
</script>
