<%- include("../partials/head", { title: "Update Profile" }) %>

<%
const skills = profileSkillOptions || [];
const qualifications = qualificationOptions || [];
const statusOptions = availabilityStatusOptions || [];
const selectedSkills = nurse.skills || [];
const selectedQualifications = nurse.qualifications || [];
const workLocationsRaw = (nurse.workLocations || []).join(", ");
%>

<section class="form-section">
  <h1>Professional Profile</h1>
  <p>Upload clear documents and keep your professional details updated.</p>

  <form method="POST" action="/nurse/profile/edit" enctype="multipart/form-data" class="form-grid" id="profileEditForm">
    <label>
      City <span class="required-indicator" title="Required"></span>
      <input name="city" type="text" value="<%= nurse.city || '' %>" required />
    </label>

    <label>
      Aadhaar Number
      <input name="aadhaarNumber" type="text" maxlength="12" pattern="[0-9]{12}" value="<%= nurse.aadhaarNumber || nurse.aadharNumber || '' %>" placeholder="12-digit Aadhaar" />
    </label>

    <label>
      Experience (Years) <span class="required-indicator" title="Required"></span>
      <input name="experienceYears" type="number" min="0" max="60" value="<%= nurse.experienceYears || 0 %>" required />
    </label>

    <label>
      Experience (Months) <span class="required-indicator" title="Required"></span>
      <input name="experienceMonths" type="number" min="0" max="11" value="<%= nurse.experienceMonths || 0 %>" required />
    </label>

    <label class="full-width">
      Availability Status <span class="required-indicator" title="Required"></span>
      <select name="availabilityStatus" required>
        <option value="">Select availability...</option>
        <% statusOptions.forEach(function(option) { %>
          <option value="<%= option %>" <%= nurse.availabilityStatus === option ? "selected" : "" %>><%= option %></option>
        <% }) %>
      </select>
    </label>

    <label class="full-width">
      Work Locations (comma separated)
      <input name="workLocationsRaw" type="text" value="<%= workLocationsRaw %>" placeholder="Delhi, Noida, Gurugram" />
    </label>

    <label class="full-width">
      Current Address
      <textarea name="currentAddress" rows="2" placeholder="Current residential address"><%= nurse.currentAddress || nurse.address || '' %></textarea>
    </label>

    <div class="full-width">
      <div class="skill-header">
        <h3>Skills</h3>
        <button type="button" id="editSkillsBtn" class="btn small">Edit</button>
      </div>

      <!-- Selected Skills Preview -->
      <div id="selectedSkillsPreview" class="tags-wrap">
        <% selectedSkills.forEach(function(skill) { %>
          <span class="skill-tag">
            <%= skill %>
          </span>
        <% }) %>
      </div>

      <!-- Hidden Skill Editor Panel -->
      <div id="skillEditor" class="skill-editor hidden">
        
        <input type="text" id="skillSearch" placeholder="Search or type to add skill..." />

        <!-- Selected Skills -->
        <div id="selectedSkillsContainer" class="tags-wrap">
          <% selectedSkills.forEach(function(skill) { %>
            <span class="skill-tag removable" data-value="<%= skill %>">
              <%= skill %> <span class="remove-skill">&times;</span>
              <input type="hidden" name="skills" value="<%= skill %>" />
            </span>
          <% }) %>
        </div>

        <!-- Available Skill Options -->
        <div id="skillOptionsList" class="skill-options">
          <% skills.forEach(function(skill) { %>
            <div class="skill-option" data-value="<%= skill %>">
              <%= skill %>
            </div>
          <% }) %>
        </div>
      </div>
    </div>

    <%- include("../partials/nurse-qualification-module", { nurse }) %>

    <div class="full-width">
      <h3>Documents (PDF/JPG/PNG, 2MB max each)</h3>
      <p class="doc-note">Upload both 10th Marksheet and Highest Certificate to unlock 100% profile completion.</p>
    </div>

    <label class="full-width">
      Profile Picture
      <input type="file" name="profilePic" id="profilePicInput" accept=".jpg,.jpeg,.png,.pdf" />
      <% if (nurse.profileImagePath) { %>
        <a href="<%= nurse.profileImagePath %>" target="_blank" rel="noopener noreferrer">Current Profile File</a>
      <% } %>
    </label>

    <label class="full-width required-upload">
      10th Marksheet
      <input type="file" name="tenthCert" id="tenthCertInput" accept=".jpg,.jpeg,.png,.pdf" />
      <% if (nurse.tenthCertUrl) { %>
        <a href="<%= nurse.tenthCertUrl %>" target="_blank" rel="noopener noreferrer">Current 10th Certificate</a>
      <% } else { %>
        <small class="warn-text">Required for 100% completion</small>
      <% } %>
    </label>

    <label class="full-width required-upload">
      Highest Certificate
      <input type="file" name="highestCert" id="highestCertInput" accept=".jpg,.jpeg,.png,.pdf" />
      <% if (nurse.highestCertUrl) { %>
        <a href="<%= nurse.highestCertUrl %>" target="_blank" rel="noopener noreferrer">Current Highest Certificate</a>
      <% } else { %>
        <small class="warn-text">Required for 100% completion</small>
      <% } %>
    </label>

    <label class="full-width">
      Resume
      <input type="file" name="resume" id="resumeInput" accept=".jpg,.jpeg,.png,.pdf" />
      <% if (nurse.resumeUrl) { %>
        <a href="<%= nurse.resumeUrl %>" target="_blank" rel="noopener noreferrer">Current Resume</a>
      <% } %>
    </label>

    <button type="submit" class="btn primary full-width" id="submitBtn">Save Profile</button>
    <a href="/nurse/profile" class="btn secondary full-width" style="text-align: center;">Cancel</a>
  </form>
</section>

<style>
.form-section {
  max-width: 860px;
  margin: 0 auto;
}
.form-section h1 {
  margin-bottom: 0.3rem;
}
.form-section > p {
  margin-bottom: 1.2rem;
  color: #4f6880;
}
.form-grid {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 0.9rem;
}
.form-grid label {
  display: flex;
  flex-direction: column;
  gap: 0.45rem;
  font-weight: 600;
  color: #102a44;
}
.form-grid input,
.form-grid select,
.form-grid textarea {
  border: 1px solid #c9d9de;
  border-radius: 10px;
  padding: 0.62rem 0.68rem;
  background: #fbfdfd;
  font: inherit;
}
.full-width {
  grid-column: 1 / -1;
}
.checkbox-grid {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 0.5rem;
}
.check-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-weight: 500;
}
.check-item input[type="checkbox"] {
  width: 18px;
  height: 18px;
}
.skill-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.skill-editor {
  margin-top: 10px;
  padding: 12px;
  border: 1px solid #d7e4f2;
  border-radius: 12px;
  background: #f9fbff;
}

.hidden {
  display: none;
}

.skill-options {
  margin-top: 10px;
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 8px;
  max-height: 200px;
  overflow-y: auto;
}

.skill-option {
  padding: 6px 10px;
  border-radius: 8px;
  background: #eef2ff;
  cursor: pointer;
  font-size: 0.9rem;
}

.skill-option:hover {
  background: #dbeafe;
}

.skill-tag.removable {
  cursor: pointer;
}

.remove-skill {
  margin-left: 6px;
  font-weight: bold;
  cursor: pointer;
}
.doc-note {
  margin: 0;
  color: #7b4b00;
}
.warn-text {
  color: #b42318;
}
.required-upload {
  padding: 0.75rem;
  border-radius: 10px;
  border: 1px dashed #f3b4b4;
  background: #fff7f7;
}
@media (max-width: 768px) {
  .form-grid {
    grid-template-columns: 1fr;
  }
  .checkbox-grid {
    grid-template-columns: 1fr;
  }
}
</style>

<script>
const MAX_FILE_SIZE_BYTES = 2 * 1024 * 1024;
const ALLOWED_FILE_EXTENSIONS = ["pdf", "jpg", "jpeg", "png"];

document.querySelectorAll("#profileEditForm input[type='file']").forEach((input) => {
  input.addEventListener("change", (event) => {
    const file = event.target.files && event.target.files[0];
    if (!file) return;
    const extension = (file.name.split(".").pop() || "").toLowerCase();
    if (!ALLOWED_FILE_EXTENSIONS.includes(extension)) {
      alert("Only PDF, JPG, and PNG files are allowed.");
      event.target.value = "";
      return;
    }
    if (file.size > MAX_FILE_SIZE_BYTES) {
      alert("Each file must be 2MB or smaller.");
      event.target.value = "";
    }
  });
});

document.getElementById("profileEditForm").addEventListener("submit", () => {
  const submitBtn = document.getElementById("submitBtn");
  submitBtn.disabled = true;
  submitBtn.textContent = "Saving...";
});

const editBtn = document.getElementById("editSkillsBtn");
const skillEditor = document.getElementById("skillEditor");
const skillSearch = document.getElementById("skillSearch");
const options = document.querySelectorAll(".skill-option");
const selectedContainer = document.getElementById("selectedSkillsContainer");

if (editBtn) {
  editBtn.addEventListener("click", () => {
    skillEditor.classList.toggle("hidden");
  });
}

function updatePreview() {
  const preview = document.getElementById("selectedSkillsPreview");
  preview.innerHTML = "";
  selectedContainer.querySelectorAll(".skill-tag").forEach(tag => {
    const span = document.createElement("span");
    span.className = "skill-tag";
    span.textContent = tag.dataset.value;
    preview.appendChild(span);
  });
}

function addSkill(value) {
  if (selectedContainer.querySelectorAll(".skill-tag").length >= 20) {
    alert("Maximum 20 skills allowed.");
    return;
  }

  if (selectedContainer.querySelector(`[data-value="${value}"]`)) return;

  const tag = document.createElement("span");
  tag.className = "skill-tag removable";
  tag.dataset.value = value;
  tag.innerHTML = `${value} <span class="remove-skill">&times;</span>
    <input type="hidden" name="skills" value="${value}" />`;

  selectedContainer.appendChild(tag);
  updatePreview();
}

options.forEach(option => {
  option.addEventListener("click", () => {
    addSkill(option.dataset.value);
  });
});

if (skillSearch) {
  skillSearch.addEventListener("input", (e) => {
    const search = e.target.value.toLowerCase();
    options.forEach(option => {
      option.style.display =
        option.dataset.value.toLowerCase().includes(search)
          ? "block"
          : "none";
    });
  });
}

if (selectedContainer) {
  selectedContainer.addEventListener("click", (e) => {
    if (e.target.classList.contains("remove-skill")) {
      e.target.parentElement.remove();
      updatePreview();
    }
  });
}
</script>

<%- include("../partials/footer") %>
