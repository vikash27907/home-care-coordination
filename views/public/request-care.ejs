<%- include("../partials/head", { title }) %>

<section class="form-section">
  <h1>Patient Care Request</h1>
  <p>Share your care needs and our coordination team will contact you with the next steps.</p>

  <% if (preferredNurse) { %>
  <div class="card selected-nurse">
    <h3>Preferred Nurse Selected</h3>
    <p><strong><%= preferredNurse.fullName %></strong> (<%= preferredNurse.isAvailable ? 'Available' : 'Not Available' %>)</p>
    <p>Skills: <%= preferredNurse.skills.join(', ') || '-' %></p>
  </div>
  <% } %>

  <form method="POST" action="/request-care" class="form-grid" id="requestCareForm">
    <input type="hidden" name="preferredNurseId" value="<%= preferredNurse ? preferredNurse.id : '' %>" />
    
    <label>
      Full Name <span class="required-indicator" title="Required"></span>
      <input name="fullName" type="text" required />
    </label>
    
    <label>
      Email <span class="required-indicator" title="Required"></span>
      <input name="email" type="email" required />
    </label>
    
    <label>
      Phone Number <span class="required-indicator" title="Required"></span>
      <input 
        name="phoneNumber" 
        type="tel" 
        maxlength="10" 
        pattern="[6-9][0-9]{9}"
        placeholder="10-digit mobile number"
        required 
        title="Enter 10-digit Indian mobile number starting with 6, 7, 8, or 9"
      />
    </label>
    
    <label>
      City <span class="required-indicator" title="Required"></span>
      <input name="city" type="text" required />
    </label>
    
    <!-- Service Schedule (Standardized Options) -->
    <label class="full-width">
      Service Schedule <span class="required-indicator" title="Required"></span>
      <select name="serviceSchedule" id="serviceSchedule" required>
        <option value="">Select service schedule...</option>
        <option value="one_time_visit">One-Time Visit</option>
        <option value="8_hour_shift">8-Hour Shift</option>
        <option value="12_hour_shift">12-Hour Shift</option>
        <option value="day_shift">Day Shift</option>
        <option value="night_shift">Night Shift</option>
        <option value="24_hour_shift">24-Hour Shift</option>
        <option value="live_in_care">Live-In Care</option>
      </select>
      <small class="helper-text">Select the type of care service you need</small>
    </label>
    
    <!-- Service Duration - New Structured Format -->
    <label class="full-width">
      Service Duration <span class="required-indicator" title="Required"></span>
      <div class="duration-inputs">
        <input 
          name="durationValue" 
          type="number" 
          min="1" 
          placeholder="Enter value"
          required
          class="duration-value"
        />
        <select name="durationUnit" id="durationUnit" required>
          <option value="">Select unit...</option>
          <% durationUnits.forEach(function(unit) { %>
            <option value="<%= unit.value %>"><%= unit.label %></option>
          <% }); %>
        </select>
      </div>
      <small class="helper-text">Enter duration (e.g., 8 Days, 3 Months, 1 Year)</small>
    </label>
    
    <!-- Budget Range - Unified Fields -->
    <div class="full-width" id="budgetSection">
      <label id="budgetLabel">
        Monthly Budget Range (₹) <span class="required-indicator" title="Required"></span>
      </label>
      <div class="budget-inputs">
        <input 
          name="budgetMin" 
          type="number" 
          id="budgetMin"
          min="5000" 
          max="200000"
          step="100"
          placeholder="Minimum"
          required
        />
        <input 
          name="budgetMax" 
          type="number" 
          id="budgetMax"
          min="5000" 
          max="200000"
          step="100"
          placeholder="Maximum"
          required
        />
      </div>
      <small class="helper-text" id="budgetHelper">
        Enter your comfortable monthly budget range
      </small>
    </div>
    
    <!-- Notes -->
    <label class="full-width">
      Additional Notes
      <textarea name="notes" rows="3" placeholder="Any specific requirements, medical conditions, or special instructions..."></textarea>
    </label>
    
    <button type="submit" class="btn primary full-width btn-submit" id="submitBtn">
      <span class="btn-text">Submit Request</span>
      <span class="spinner" style="display: none;"></span>
    </button>
  </form>

  <aside class="urgent-support">
    <h2>Need Immediate Assistance?</h2>
    <p>
      For emergency or urgent care response, connect with our support team directly on WhatsApp.
    </p>
    <div class="support-row">
      <a
        class="btn whatsapp"
        href="https://wa.me/919138913355?text=Hello%20Prisha%20Home%20Care%2C%20I%20need%20immediate%20patient%20care%20support."
        target="_blank"
        rel="noopener"
        >Connect on WhatsApp</a
      >
      <span class="support-number">+91 9138913355</span>
    </div>
  </aside>
</section>

<script>
(function() {
  'use strict';

  // Configuration
  var CONFIG = {
    DAILY_BUDGET_MIN: <%= dailyBudgetMin %>,
    DAILY_BUDGET_MAX: <%= dailyBudgetMax %>,
    MONTHLY_BUDGET_MIN: <%= budgetMin %>,
    MONTHLY_BUDGET_MAX: <%= budgetMax %>
  };

  // DOM Elements
  var elements = {
    durationUnit: document.getElementById('durationUnit'),
    durationValue: document.querySelector('input[name="durationValue"]'),
    budgetMin: document.getElementById('budgetMin'),
    budgetMax: document.getElementById('budgetMax'),
    budgetLabel: document.getElementById('budgetLabel'),
    budgetHelper: document.getElementById('budgetHelper'),
    form: document.getElementById('requestCareForm'),
    submitBtn: document.getElementById('submitBtn')
  };

  // Calculate budget type based on duration
  function calculateBudgetType(unit, value) {
    if (unit === 'days' && value <= 15) {
      return 'daily';
    }
    return 'monthly';
  }

  // Update budget field constraints and labels
  function updateBudgetConstraints() {
    var unit = elements.durationUnit.value;
    var value = parseInt(elements.durationValue.value, 10) || 0;
    var budgetType = calculateBudgetType(unit, value);

    if (budgetType === 'daily') {
      // Update to daily budget
      elements.budgetLabel.innerHTML = 'Daily Budget Range (₹) <span class="required-indicator" title="Required"></span>';
      elements.budgetHelper.textContent = 'Daily budget: ₹' + CONFIG.DAILY_BUDGET_MIN.toLocaleString('en-IN') + ' – ₹' + CONFIG.DAILY_BUDGET_MAX.toLocaleString('en-IN');
      
      elements.budgetMin.setAttribute('min', CONFIG.DAILY_BUDGET_MIN);
      elements.budgetMin.setAttribute('max', CONFIG.DAILY_BUDGET_MAX);
      elements.budgetMax.setAttribute('min', CONFIG.DAILY_BUDGET_MIN);
      elements.budgetMax.setAttribute('max', CONFIG.DAILY_BUDGET_MAX);
      
      // Clear if values are outside daily range
      if (elements.budgetMin.value && (elements.budgetMin.value < CONFIG.DAILY_BUDGET_MIN || elements.budgetMin.value > CONFIG.DAILY_BUDGET_MAX)) {
        elements.budgetMin.value = '';
      }
      if (elements.budgetMax.value && (elements.budgetMax.value < CONFIG.DAILY_BUDGET_MIN || elements.budgetMax.value > CONFIG.DAILY_BUDGET_MAX)) {
        elements.budgetMax.value = '';
      }
    } else {
      // Update to monthly budget
      elements.budgetLabel.innerHTML = 'Monthly Budget Range (₹) <span class="required-indicator" title="Required"></span>';
      elements.budgetHelper.textContent = 'Monthly budget: ₹' + CONFIG.MONTHLY_BUDGET_MIN.toLocaleString('en-IN') + ' – ₹' + CONFIG.MONTHLY_BUDGET_MAX.toLocaleString('en-IN');
      
      elements.budgetMin.setAttribute('min', CONFIG.MONTHLY_BUDGET_MIN);
      elements.budgetMin.setAttribute('max', CONFIG.MONTHLY_BUDGET_MAX);
      elements.budgetMax.setAttribute('min', CONFIG.MONTHLY_BUDGET_MIN);
      elements.budgetMax.setAttribute('max', CONFIG.MONTHLY_BUDGET_MAX);
      
      // Clear if values are outside monthly range
      if (elements.budgetMin.value && (elements.budgetMin.value < CONFIG.MONTHLY_BUDGET_MIN || elements.budgetMin.value > CONFIG.MONTHLY_BUDGET_MAX)) {
        elements.budgetMin.value = '';
      }
      if (elements.budgetMax.value && (elements.budgetMax.value < CONFIG.MONTHLY_BUDGET_MIN || elements.budgetMax.value > CONFIG.MONTHLY_BUDGET_MAX)) {
        elements.budgetMax.value = '';
      }
    }
  }

  // Validate budget range
  function validateBudget() {
    var unit = elements.durationUnit.value;
    var value = parseInt(elements.durationValue.value, 10) || 0;
    var budgetType = calculateBudgetType(unit, value);
    var min = parseFloat(elements.budgetMin.value);
    var max = parseFloat(elements.budgetMax.value);

    if (budgetType === 'daily') {
      if (min < CONFIG.DAILY_BUDGET_MIN || min > CONFIG.DAILY_BUDGET_MAX) {
        return 'Daily budget must be between ₹' + CONFIG.DAILY_BUDGET_MIN.toLocaleString('en-IN') + ' and ₹' + CONFIG.DAILY_BUDGET_MAX.toLocaleString('en-IN');
      }
      if (max < CONFIG.DAILY_BUDGET_MIN || max > CONFIG.DAILY_BUDGET_MAX) {
        return 'Daily budget must be between ₹' + CONFIG.DAILY_BUDGET_MIN.toLocaleString('en-IN') + ' and ₹' + CONFIG.DAILY_BUDGET_MAX.toLocaleString('en-IN');
      }
    } else {
      if (min < CONFIG.MONTHLY_BUDGET_MIN || min > CONFIG.MONTHLY_BUDGET_MAX) {
        return 'Monthly budget must be between ₹' + CONFIG.MONTHLY_BUDGET_MIN.toLocaleString('en-IN') + ' and ₹' + CONFIG.MONTHLY_BUDGET_MAX.toLocaleString('en-IN');
      }
      if (max < CONFIG.MONTHLY_BUDGET_MIN || max > CONFIG.MONTHLY_BUDGET_MAX) {
        return 'Monthly budget must be between ₹' + CONFIG.MONTHLY_BUDGET_MIN.toLocaleString('en-IN') + ' and ₹' + CONFIG.MONTHLY_BUDGET_MAX.toLocaleString('en-IN');
      }
    }
    
    if (max < min) {
      return 'Maximum budget cannot be less than minimum budget.';
    }
    
    return null;
  }

  // Event Listeners
  function initEventListeners() {
    // Update budget when duration changes
    elements.durationUnit.addEventListener('change', updateBudgetConstraints);
    elements.durationValue.addEventListener('input', updateBudgetConstraints);

    // Form submission validation
    elements.form.addEventListener('submit', function(e) {
      // Validate budget
      var budgetError = validateBudget();
      if (budgetError) {
        e.preventDefault();
        alert(budgetError);
        return;
      }

      // Show loading state
      elements.submitBtn.classList.add('loading');
      elements.submitBtn.querySelector('.btn-text').textContent = 'Submitting...';
      elements.submitBtn.querySelector('.spinner').style.display = 'inline-block';
      elements.submitBtn.disabled = true;
    });
  }

  // Initialize
  function init() {
    initEventListeners();
    // Set initial budget constraints
    updateBudgetConstraints();
  }

  // Run on DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>

<style>
.duration-inputs,
.budget-inputs {
  display: flex;
  gap: 10px;
  margin-top: 8px;
}

.duration-value {
  flex: 1;
  max-width: 150px;
}

.duration-inputs select {
  flex: 1;
}

.budget-inputs input {
  flex: 1;
}

.helper-text {
  display: block;
  margin-top: 4px;
  color: #666;
  font-size: 0.875rem;
}
</style>

<%- include("../partials/footer") %>
